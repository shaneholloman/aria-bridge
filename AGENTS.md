# Repository Guidelines

## Project Structure & Module Organization

- `src/` contains the TypeScript source. Key modules: `client.ts` (bridge entry point), `websocket.ts` (WS transport), `platform.ts` (environment detection), `throttle.ts` (rate limiting), and `types.ts` (shared contracts). Use named exports.
- `bin/` contains the `aria-bridge-host.js` CLI for running the singleton WebSocket server per workspace.
- `demo/` holds runnable examples for Node, web, React Native, plus a simple WS server. Use these for manual verification. Includes test scripts for the host CLI.
- `dist/` is build output generated by `tsup`; never edit by hand.
- Tooling configs live at `package.json` and `tsconfig.json`; `README.md` and [docs/usage.md](docs/usage.md) describe runtime usage.

## Build, Test, and Development Commands

- `bun install` — install dependencies.
- `bun run build` — bundle `src/index.ts` to CJS/ESM with type declarations in `dist/` (cleans before build).
- `bun run dev` — watch mode rebuild for local development.
- `bun test` — runs `node demo/node-demo.js`; start `node demo/server.js` in another shell to see live bridge traffic.
- `bun run typecheck` — strict TypeScript compilation without emitting files.
- `node bin/aria-bridge-host.js [workspace-path]` — start the singleton host server for a workspace (or use `bunx aria-bridge-host`).
- `node demo/test-host-flow.js` — test the complete host flow (host + consumer + bridge).
- `node demo/test-singleton-lock.js` — test singleton lock behavior and stale lock detection.

## Coding Style & Naming Conventions

- Language: TypeScript (ES2020 target, bundler module resolution), strict mode on.
- Indentation: 2 spaces; prefer trailing commas and single quotes as shown in `src/`.
- Exports: favor named exports from leaf modules re-exported via `src/index.ts`.
- Types: define shared shapes in `types.ts`; prefer `type` aliases over `interface` unless extension is required.
- Side effects: keep modules side-effect free; `startBridge` should remain the only initializer.
- Avoid using `import.meta` in runtime code; Metro/Hermes bundle the ESM build into non-module scripts and will throw `SyntaxError: Cannot use 'import.meta' outside a module` (we've hit this already).

## Testing Guidelines

- Current coverage is manual via the `demo/` apps. When adding features, include minimal unit tests (Vitest/Jest acceptable) under `__tests__/` or alongside files as `*.test.ts`.
- Keep tests deterministic; mock network calls instead of hitting real sockets.
- For manual checks, run `node demo/server.js` then `bun test` and exercise console/error paths in the client.

## Commit & Pull Request Guidelines

- Use Conventional Commits (`feat:`, `fix:`, `chore:`, `docs:`, `test:`). Scope is optional but encouraged (e.g., `feat: add react-native hook`).
- PRs should include: short description, testing notes (commands run), and any screenshots/logs from demo runs. Keep PRs small and focused; avoid bundling unrelated refactors.
- Do not commit secrets; configure bridge secrets via options or environment and keep `DEFAULT_SECRET` for demos only.
